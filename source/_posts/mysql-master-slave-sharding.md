---
title: mysql6：分库分表
date: 2019-09-22 11:39:47
tags: mysql
---
# mysql分库分表

# 数据库性能瓶颈

- 数据库连接有限：mysql数据库默认100个连接，单机最大可设置1500
- 表数量多过多或单表的记录数量达到千万级别
- 硬件问题

## 数据库性能优化

- 参数优化
- 缓存、索引
- 读写分离
- 分库分表

## 分库分表介绍

### 使用背景

- 当表数量达到几百上千张表时，众多的业务模块都访问这个数据库，压力会比较大，考虑对其进行分库。
- 当表的数据量达到了千万级别，在做很多操作时都比较吃力，考虑对其进行分库或者分表。

### 数据切分方案

数据的切分根据其切分规则类型，可以分为2种切分模式：

- **垂直切分**：按照业务模块进行拆分，将不同模块的表拆分到不同的数据库中。

  **垂直分库**

  {% asset_img mysql-master-slave-sharding-1.png %}

  **垂直分表**：大表拆小表

  {% asset_img mysql-master-slave-sharding-2.png %}

- **水平拆分**：将一张大表按照一定的拆分规则，按照行切分成不同的表或者切分到不同的库中。

  **水平切分按照行切**

  {% asset_img mysql-master-slave-sharding-3.png %}

### 水平切分规则

- **按照ID取模**：对id进行取模，余数决定该行数据切分到哪个表或者库中。
- **按照日期**：按照年月日，将数据切分到不同的表或者库中。
- **按照范围**：可以对某一列按照范围进行拆分，不同的范围切分到不同的表或者数据库中。

### 切分原则

- 能不切分尽量不要切分
- 如果切分一定要选择好合适的切分规则，提前规划好
- 数据切分尽量通过数据冗余或者表分组来降低跨库join的可能

### 分库分表需要解决的问题

### 分布式事务问题

补偿事务，利用日志记录等方式实现最终一致性。

### 分布式主键ID问题

多个库中表的主键冲突

解决方案：

- redis incr命令
- 数据库生成主键
- UUID
- snowflake算法

### 跨库join的问题

解决方案：

- 对于全局表（如配置表），可以在每一个库中都建立一个相同的表

- E-R分片，将有E-R关系的记录都记录到一个库中。

  如：user表分片后，user的address信息表以uid进行分片，这样可以确保同一个user的user记录和address记录在同一个库中。

如果必须要跨库join，则最多2张表

### 分库分表技术实现

- 阿里的TDDL、Cobar
- 基于阿里Cobar开发的Mycat
- sharding-jdbc
